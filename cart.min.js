const productAdded=async()=>{try{let e=JSON.parse(localStorage.getItem("userCart"));if(null!==e){document.getElementById("cart-count").innerHTML=e.length,document.querySelector("p.alert").classList.add("d-none");const t=document.getElementById("cart"),n=document.createElement("table");n.setAttribute("class","table table-responsive table-hover text-secondary px-5 text-center"),t.appendChild(n);const a=document.createElement("thead");a.setAttribute("class","thead-light"),n.appendChild(a);const s=document.createElement("tr");s.setAttribute("class","text-left h5"),a.appendChild(s);const d=document.createElement("th");d.textContent="Article",s.appendChild(d);const c=document.createElement("th");c.textContent="Prix",s.appendChild(c);const l=document.createElement("th");l.textContent="Quantité",s.appendChild(l);const r=document.createElement("th");r.textContent="Sous-total",s.appendChild(r);const o=document.createElement("tbody");o.setAttribute("id","cart-tablebody"),n.appendChild(o);const i=document.createElement("div");i.setAttribute("class","row text-center mx-auto col-md-9"),t.appendChild(i);const m=document.createElement("p");m.setAttribute("class","col-10 col-md-8 mx-auto h5 my-3 p-0 align-middle"),m.textContent="TOTAL À PAYER: ",i.appendChild(m);const u=document.createElement("span");u.setAttribute("id","total-cart"),u.setAttribute("class","text-primary"),m.appendChild(u);const p=[];let g=0;e.forEach(e=>{p[g]=e._id,g++});const v=p.reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{});let h=0;for(let[t,n]of Object.entries(v)){const a=encodeURI("http://localhost:3000/api/cameras/"+t),s=await fetch(a),d=await s.json();h++;const c=document.createElement("tr");c.setAttribute("class","text-center h6"),c.setAttribute("id",d._id),o.appendChild(c);const l=document.createElement("td");l.setAttribute("class"," text-left align-middle"),c.appendChild(l);const r=document.createElement("img");r.setAttribute("src",d.imageUrl),r.setAttribute("alt","name"),r.setAttribute("width","100"),l.appendChild(r);const i=document.createElement("a");i.setAttribute("class","align-middle pl-3"),i.setAttribute("href","product.html?id="+`${d._id}`),i.setAttribute("alt","lien vers "+`${d.name}`),i.innerHTML=d.name,l.appendChild(i);const m=document.createElement("td");m.setAttribute("class","align-middle"),m.innerHTML=d.price/100+"€",c.appendChild(m);const u=document.createElement("td");u.setAttribute("class","align-middle"),u.innerHTML=n,c.appendChild(u);const v=document.createElement("td");v.setAttribute("class","align-middle"),v.innerHTML=n*d.price/100+" €",c.appendChild(v);const b=document.createElement("td");b.setAttribute("class","align-middle border-0"),c.appendChild(b);const E=document.createElement("button");E.setAttribute("type","button"),E.setAttribute("id","btn-remove"+h),E.setAttribute("class","btn btn-secondary"),E.innerHTML="X",b.appendChild(E),document.getElementById("btn-remove"+h).onclick=(()=>{e.forEach(e=>{p[g]=e._id,g++});const n=p.indexOf(t);L(n)})}let b=0;e.forEach(e=>{b+=parseInt(e.price/100)}),document.getElementById("total-cart").innerHTML=b+"€";const E=document.createElement("button");E.setAttribute("class","col-8 col-md-4 mx-auto btn btn-danger"),E.textContent="Vider le panier !",E.addEventListener("click",()=>{localStorage.clear(),location.reload()}),i.appendChild(E);const L=t=>{e.splice(t,1),localStorage.setItem("userCart",JSON.stringify(e)),location.reload()},x=[];let y={};const f=document.getElementById("validForm"),A=document.getElementById("firstName"),C=document.getElementById("lastName"),I=document.getElementById("email"),T=document.getElementById("address"),B=document.getElementById("city"),H=/[0-9]/,M=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,k=/[§!@#$%^&*().?":{}|<>]/;A.addEventListener("change",()=>{if(""==A.value||1==k.test(A.value)||1==H.test(A.value)){const e=document.getElementById("feedback-firstname");return e.innerHTML="Un prénom valide est obligatoire",e.classList.remove("text-success"),e.classList.add("text-danger"),!1}{const e=document.getElementById("feedback-firstname");return e.innerHTML="le prénom est valide",e.classList.remove("text-danger"),e.classList.add("text-success"),!0}}),C.addEventListener("change",()=>{if(""==C.value||1==k.test(C.value)||1==H.test(C.value)){const e=document.getElementById("feedback-lastname");return e.innerHTML="Un nom valide est obligatoire",e.classList.remove("text-success"),e.classList.add("text-danger"),!1}{const e=document.getElementById("feedback-lastname");return e.innerHTML="le nom est valide",e.classList.remove("text-danger"),e.classList.add("text-success"),!0}}),I.addEventListener("change",()=>{if(M.test(I.value)){const e=document.getElementById("feedback-email");return e.innerHTML="l'email est valide",e.classList.remove("text-danger"),e.classList.add("text-success"),!0}{const e=document.getElementById("feedback-email");return e.innerHTML="l'email n'est pas valide",e.classList.remove("text-success"),e.classList.add("text-danger"),!1}}),T.addEventListener("change",()=>{if(""==T.value||1==k.test(T.value)){const e=document.getElementById("feedback-address");return e.innerHTML="l'adresse n'est pas valide",e.classList.remove("text-success"),e.classList.add("text-danger"),!1}{const e=document.getElementById("feedback-address");return e.innerHTML="l'adresse est valide",e.classList.remove("text-danger"),e.classList.add("text-success"),!0}}),B.addEventListener("change",()=>{if(""==B.value||1==k.test(B.value)||1==H.test(B.value)){const e=document.getElementById("feedback-city");return e.innerHTML="Une ville valide est obligatoire",e.classList.remove("text-success"),e.classList.add("text-danger"),!1}{const e=document.getElementById("feedback-city");return e.innerHTML="le prénom est valide",e.classList.remove("text-danger"),e.classList.add("text-success"),!0}}),f.addEventListener("submit",t=>{if(t.preventDefault(),A.value&&C.value&&I.value&&T.value&&B.value){e.forEach(e=>{x.push(e._id)});const t=new TextEncoder,n={contact:y={firstName:t.encode(A.value),lastName:t.encode(C.value),email:t.encode(I.value),address:t.encode(T.value),city:t.encode(B.value)},products:x};fetch("http://localhost:3000/api/cameras/order",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(n)}).then(e=>e.json()).then(e=>{let t=e;localStorage.setItem("order",JSON.stringify(t)),localStorage.setItem("priceCart",b),document.location.href="validate.html"}).catch(e=>{console.error("Erreur de connexion, veuillez réessayer:",e)})}else console.log("Il y a une erreur dans le formulaire")})}else alert("Votre panier est vide")}catch(e){console.log(e)}};productAdded();