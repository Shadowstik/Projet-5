const productAdded=async()=>{try{let e=JSON.parse(localStorage.getItem("userCart"));if(null!==e){document.getElementById("cart-count").innerHTML=e.length,document.querySelector("p.alert").classList.add("d-none");const t=document.getElementById("cart"),n=document.getElementById("responsive"),a=document.createElement("table");a.setAttribute("class","table table-hover text-secondary px-5 text-center"),n.appendChild(a);const s=document.createElement("thead");s.setAttribute("class","thead-light"),a.appendChild(s);const d=document.createElement("tr");d.setAttribute("class","text-left h5"),s.appendChild(d);const c=document.createElement("th");c.textContent="Article",d.appendChild(c);const l=document.createElement("th");l.textContent="Prix",d.appendChild(l);const r=document.createElement("th");r.textContent="Quantité",d.appendChild(r);const o=document.createElement("th");o.textContent="Sous-total",d.appendChild(o);const i=document.createElement("tbody");i.setAttribute("id","cart-tablebody"),a.appendChild(i);const m=document.createElement("div");m.setAttribute("class","row text-center mx-auto col-md-9"),t.appendChild(m);const u=document.createElement("p");u.setAttribute("class","col-10 col-md-8 mx-auto h5 my-3 p-0 align-middle"),u.textContent="TOTAL À PAYER: ",m.appendChild(u);const p=document.createElement("span");p.setAttribute("id","total-cart"),p.setAttribute("class","text-primary"),u.appendChild(p);const g=[];let v=0;e.forEach(e=>{g[v]=e._id,v++});const h=g.reduce((e,t)=>(e[t]=(e[t]||0)+1,e),{});let b=0;for(let[t,n]of Object.entries(h)){const a=encodeURI("http://localhost:3000/api/cameras/"+t),s=await fetch(a),d=await s.json();b++;const c=document.createElement("tr");c.setAttribute("class","text-center h6"),c.setAttribute("id",d._id),i.appendChild(c);const l=document.createElement("td");l.setAttribute("class"," text-left align-middle"),c.appendChild(l);const r=document.createElement("img");r.setAttribute("src",d.imageUrl),r.setAttribute("alt","name"),r.setAttribute("width","100"),l.appendChild(r);const o=document.createElement("a");o.setAttribute("class","align-middle pl-3"),o.setAttribute("href","product.html?id="+`${d._id}`),o.setAttribute("alt","lien vers "+`${d.name}`),o.innerHTML=d.name,l.appendChild(o);const m=document.createElement("td");m.setAttribute("class","align-middle"),m.innerHTML=d.price/100+"€",c.appendChild(m);const u=document.createElement("td");u.setAttribute("class","align-middle"),u.innerHTML=n,c.appendChild(u);const p=document.createElement("td");p.setAttribute("class","align-middle"),p.innerHTML=n*d.price/100+" €",c.appendChild(p);const h=document.createElement("td");h.setAttribute("class","align-middle border-0"),c.appendChild(h);const E=document.createElement("button");E.setAttribute("type","button"),E.setAttribute("id","btn-remove"+b),E.setAttribute("class","btn btn-secondary"),E.innerHTML="X",h.appendChild(E),document.getElementById("btn-remove"+b).onclick=(()=>{e.forEach(e=>{g[v]=e._id,v++});const n=g.indexOf(t);y(n)})}let E=0;e.forEach(e=>{E+=parseInt(e.price/100)}),document.getElementById("total-cart").innerHTML=E+"€";const L=document.createElement("button");L.setAttribute("class","col-8 col-md-4 mx-auto btn btn-danger"),L.textContent="Vider le panier !",L.addEventListener("click",()=>{localStorage.clear(),location.reload()}),m.appendChild(L);const y=t=>{e.splice(t,1),localStorage.setItem("userCart",JSON.stringify(e)),location.reload()},x=[];let f={};const A=document.getElementById("validForm"),C=document.getElementById("firstName"),I=document.getElementById("lastName"),B=document.getElementById("email"),T=document.getElementById("address"),H=document.getElementById("city"),M=/[0-9]/,k=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,S=/[§!@#$%^&*().?":{}|<>]/;C.addEventListener("change",()=>{if(""==C.value||1==S.test(C.value)||1==M.test(C.value)){const e=document.getElementById("feedback-firstname");return e.innerHTML="Un prénom valide est obligatoire",e.classList.remove("text-success"),e.classList.add("text-danger"),!1}{const e=document.getElementById("feedback-firstname");return e.innerHTML="le prénom est valide",e.classList.remove("text-danger"),e.classList.add("text-success"),!0}}),I.addEventListener("change",()=>{if(""==I.value||1==S.test(I.value)||1==M.test(I.value)){const e=document.getElementById("feedback-lastname");return e.innerHTML="Un nom valide est obligatoire",e.classList.remove("text-success"),e.classList.add("text-danger"),!1}{const e=document.getElementById("feedback-lastname");return e.innerHTML="le nom est valide",e.classList.remove("text-danger"),e.classList.add("text-success"),!0}}),B.addEventListener("change",()=>{if(k.test(B.value)){const e=document.getElementById("feedback-email");return e.innerHTML="l'email est valide",e.classList.remove("text-danger"),e.classList.add("text-success"),!0}{const e=document.getElementById("feedback-email");return e.innerHTML="l'email n'est pas valide",e.classList.remove("text-success"),e.classList.add("text-danger"),!1}}),T.addEventListener("change",()=>{if(""==T.value||1==S.test(T.value)){const e=document.getElementById("feedback-address");return e.innerHTML="l'adresse n'est pas valide",e.classList.remove("text-success"),e.classList.add("text-danger"),!1}{const e=document.getElementById("feedback-address");return e.innerHTML="l'adresse est valide",e.classList.remove("text-danger"),e.classList.add("text-success"),!0}}),H.addEventListener("change",()=>{if(""==H.value||1==S.test(H.value)||1==M.test(H.value)){const e=document.getElementById("feedback-city");return e.innerHTML="Une ville valide est obligatoire",e.classList.remove("text-success"),e.classList.add("text-danger"),!1}{const e=document.getElementById("feedback-city");return e.innerHTML="le prénom est valide",e.classList.remove("text-danger"),e.classList.add("text-success"),!0}}),A.addEventListener("submit",t=>{if(t.preventDefault(),C.value&&I.value&&B.value&&T.value&&H.value){e.forEach(e=>{x.push(e._id)});const t=new TextEncoder,n={contact:f={firstName:t.encode(C.value),lastName:t.encode(I.value),email:t.encode(B.value),address:t.encode(T.value),city:t.encode(H.value)},products:x};fetch("http://localhost:3000/api/cameras/order",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify(n)}).then(e=>e.json()).then(e=>{let t=e;localStorage.setItem("order",JSON.stringify(t)),localStorage.setItem("priceCart",E),document.location.href="validate.html"}).catch(e=>{console.error("Erreur de connexion, veuillez réessayer:",e)})}else console.log("Il y a une erreur dans le formulaire")})}else alert("Votre panier est vide")}catch(e){console.log(e)}};productAdded();